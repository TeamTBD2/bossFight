<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AR Ball Placement with Coordinates</title>
    <!-- Import A-Frame -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aframe/1.4.2/aframe.min.js"></script>
    <!-- Import AR.js for location-based AR -->
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>
    <style>
      body {
        margin: 0;
        overflow: hidden;
      }
      /* Styling for the coordinate displays */
      #phoneCoords,
      #objectCoords {
        position: absolute;
        background: rgba(0, 0, 0, 0.5);
        color: #fff;
        padding: 5px 10px;
        font-family: sans-serif;
        z-index: 100;
      }
      #phoneCoords {
        top: 10px;
        left: 10px;
      }
      #objectCoords {
        top: 50px;
        left: 10px;
      }
    </style>
  </head>
  <body>
    <!-- Display for phone coordinates -->
    <div id="phoneCoords">Phone Coordinates: Loading...</div>
    <!-- Display for placed object's coordinates -->
    <div id="objectCoords">Object Coordinates: None</div>

    <!-- A-Frame Scene with AR.js and gps-camera -->
    <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;">
      <a-camera gps-camera rotation-reader></a-camera>
    </a-scene>

    <script>
      // Get references to the coordinate display elements
      const phoneCoordsDiv = document.getElementById("phoneCoords");
      const objectCoordsDiv = document.getElementById("objectCoords");
      const scene = document.querySelector("a-scene");
      const gpsCameraEl = document.querySelector("[gps-camera]");

      // Update the phone's GPS coordinates as they change.
      gpsCameraEl.addEventListener("gps-camera-update-position", function (e) {
        const lat = e.detail.position.latitude;
        const lon = e.detail.position.longitude;
        phoneCoordsDiv.textContent = `Phone Coordinates: ${lat.toFixed(
          6
        )}, ${lon.toFixed(6)}`;
      });

      // Listen for click/touch events on the A-Frame scene.
      scene.addEventListener("click", function (event) {
        // Convert the click/touch coordinates to normalized device coordinates (NDC)
        const mouse = new THREE.Vector2();
        mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
        mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

        // Get the camera's THREE.js object and create a raycaster
        const cameraEl = document.querySelector("a-camera");
        const cameraObj = cameraEl.object3D;
        const raycaster = new THREE.Raycaster();
        raycaster.setFromCamera(mouse, cameraObj);

        // Define a fixed distance (5 meters) from the camera along the ray.
        const distance = 5;
        const clickPosition = new THREE.Vector3()
          .copy(raycaster.ray.origin)
          .add(raycaster.ray.direction.multiplyScalar(distance));

        // Use the gps-camera component's localToGPS function to convert the local position to GPS coordinates.
        const gpsCamera = gpsCameraEl.components["gps-camera"];
        const gpsPosition = gpsCamera.localToGPS(clickPosition);

        // Create a small ball (a-sphere) with a 0.2 m radius.
        const ball = document.createElement("a-sphere");
        ball.setAttribute("radius", "0.2");
        ball.setAttribute("color", "#FF0000");
        // Use the gps-entity-place component so the ball is fixed at the computed GPS position.
        ball.setAttribute(
          "gps-entity-place",
          `latitude: ${gpsPosition.latitude}; longitude: ${gpsPosition.longitude};`
        );
        scene.appendChild(ball);

        // Update the object coordinates display.
        objectCoordsDiv.textContent = `Object Coordinates: ${gpsPosition.latitude.toFixed(
          6
        )}, ${gpsPosition.longitude.toFixed(6)}`;
      });
    </script>
  </body>
</html>
