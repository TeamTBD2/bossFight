<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AR World Space Objects</title>
  <!-- Import A-Frame -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/aframe/1.4.2/aframe.min.js"></script>
  <!-- Import AR.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ar.js/2.4.0/aframe-ar.min.js"></script>
  <!-- AR.js location-based component -->
  <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
  <style>
    body {
      margin: 0;
      overflow: hidden;
    }

    .centered {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      font-family: Arial, sans-serif;
      z-index: 999;
    }

    .hidden {
      display: none;
    }

    #startButton {
      padding: 10px 20px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      margin: 10px;
    }

    #startButton:hover {
      background-color: #45a049;
    }

    #statusInfo {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background-color: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 10px;
      border-radius: 5px;
      font-family: Arial, sans-serif;
      z-index: 999;
      max-width: 80%;
    }

    #placeObjectButton {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: #4CAF50;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      z-index: 999;
    }
  </style>
</head>

<body>
  <div id="startScreen" class="centered">
    <h2>AR World Space Objects</h2>
    <p>This app uses AR.js to place objects in fixed world space.</p>
    <p>You'll need to allow camera access.</p>
    <button id="startButton">Start AR Experience</button>
  </div>

  <!-- A-Frame scene with AR.js using just the camera marker-based approach -->
  <a-scene id="arScene" class="hidden" embedded
    arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;">

    <!-- Camera with no GPS tracking -->
    <a-entity camera></a-entity>

    <!-- World container that will stay fixed in world space -->
    <a-entity id="world-root">
      <!-- Objects will be added here -->
    </a-entity>

  </a-scene>

  <div id="statusInfo" class="hidden">
    Ready to place objects
  </div>

  <button id="placeObjectButton" class="hidden">Place Object Here</button>

  <script>
    // DOM elements
    const startButton = document.getElementById('startButton');
    const arScene = document.getElementById('arScene');
    const statusInfo = document.getElementById('statusInfo');
    const startScreen = document.getElementById('startScreen');
    const placeObjectButton = document.getElementById('placeObjectButton');
    const worldRoot = document.getElementById('world-root');

    // Track when AR has initialized
    let arInitialized = false;

    // Object counter
    let objectCount = 0;

    // Initialize AR experience
    function initAR() {
      startScreen.classList.add('hidden');
      arScene.classList.remove('hidden');
      statusInfo.classList.remove('hidden');
      placeObjectButton.classList.remove('hidden');

      // Add some initial objects in world space
      addInitialObjects();

      statusInfo.textContent = "AR initialized. Place objects in fixed world space.";
    }

    // Add initial example objects in world space
    function addInitialObjects() {
      // Create objects at various positions in world space
      const positions = [
        { position: "0 0 -5", label: "5m Forward", color: "red" },
        { position: "5 0 0", label: "5m Right", color: "blue" },
        { position: "0 0 5", label: "5m Behind", color: "green" },
        { position: "-5 0 0", label: "5m Left", color: "yellow" }
      ];

      positions.forEach(item => {
        createWorldObject(item.position, item.label, item.color);
      });
    }

    // Create an object at specific world space coordinates
    function createWorldObject(position, label, color) {
      objectCount++;

      // Create container entity
      const entity = document.createElement('a-entity');
      entity.setAttribute('position', position);
      entity.setAttribute('id', `object-${objectCount}`);

      // Add sphere
      const sphere = document.createElement('a-sphere');
      sphere.setAttribute('radius', '0.5');
      sphere.setAttribute('color', color);
      sphere.setAttribute('opacity', '0.8');

      // Add text label
      const text = document.createElement('a-text');
      text.setAttribute('value', label);
      text.setAttribute('position', '0 1 0');
      text.setAttribute('align', 'center');
      text.setAttribute('color', 'white');
      text.setAttribute('scale', '1 1 1');
      text.setAttribute('look-at', '[camera]');

      // Add components to entity
      entity.appendChild(sphere);
      entity.appendChild(text);

      // Add to world root
      worldRoot.appendChild(entity);

      console.log(`Created object at ${position} with label "${label}"`);
      return entity;
    }

    // Place object at camera's current position + offset
    function placeObjectAtCamera() {
      // Get camera entity
      const camera = document.querySelector('[camera]');

      // Get current camera position and rotation
      const cameraPosition = camera.object3D.position;
      const cameraRotation = camera.object3D.rotation;

      // Calculate position 2 meters in front of camera
      const distance = 2;

      // Create a Three.js vector for the forward direction
      const direction = new THREE.Vector3(0, 0, -1);

      // Apply camera rotation to the direction vector
      direction.applyQuaternion(camera.object3D.quaternion);

      // Multiply by distance
      direction.multiplyScalar(distance);

      // Add to camera position
      const targetPosition = new THREE.Vector3();
      targetPosition.addVectors(cameraPosition, direction);

      // Format position string
      const positionString = `${targetPosition.x.toFixed(2)} ${targetPosition.y.toFixed(2)} ${targetPosition.z.toFixed(2)}`;

      // Generate random color
      const colors = ['red', 'blue', 'green', 'yellow', 'purple', 'orange', 'cyan', 'magenta'];
      const randomColor = colors[Math.floor(Math.random() * colors.length)];

      // Create timestamp label
      const timestamp = new Date().toLocaleTimeString();
      const label = `Object ${objectCount + 1} (${timestamp})`;

      // Create the object
      createWorldObject(positionString, label, randomColor);

      statusInfo.textContent = `Object placed ${distance}m in front of you`;
    }

    // Event handlers
    startButton.addEventListener('click', initAR);
    placeObjectButton.addEventListener('click', placeObjectAtCamera);

    // Initialize scene after everything is loaded
    document.addEventListener('DOMContentLoaded', function () {
      // Listen for AR.js initialization
      const scene = document.querySelector('a-scene');
      scene.addEventListener('loaded', function () {
        console.log('A-Frame scene loaded');
      });

      // Optional: Handle AR.js camera stream initialization
      scene.addEventListener('camera-init', function () {
        console.log('AR.js camera initialized');
      });
    });
  </script>
</body>

</html>